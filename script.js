let known = {
'food': {
    'imginfo': 'DIV2K/0848.png',
    'fullres': 'https://storage.googleapis.com/hific/div2k/visualize.html?perPage=10&imgs=0848',
    'loadingRatio': '75.29411764705883%',
    'left': ['originals/kodim07.png', 'Original', 'Original'],
    'right': [
        ['outputs/mycodec/reconstructed/kodim07.png', 'JPEG quality=25', 'JPEG quality=25'],
        ['outputs/mycodec200/reconstructed/kodim07.jpg', 'JPEG quality=100', 'JPEG quality=100'],
        ['outputs/lossless/reconstructed/kodim07.png', 'PNG (lossless)', 'PNG (lossless)'],
        ['DIVIDER'],
        ['outputs/clustering/reconstructed/kodim07.png', 'Kmeans', 'Kmeans'],
        ['outputs/hific/reconstructed/kodim07.png', 'HiFiC', 'HiFiC'],
        ['outputs/stableDiff/reconstructed/kodim07.png_from_latents.png', 'Stable-diffusion', 'Stable-diffusion'],
        ['DIVIDER'],
        // ['kodim07_bpg_2x_0.313.png', 'BPG (0.313 bpp, \u22482x)', 'BPG (15 kB, \u22482x)'],
        ['originals/kodim07.png', 'Original', 'Original'],
    ],
    'thumb': 'thumbs/kodim07.jpg'
},
'shades': {
    'imginfo': 'CLIC2020/ad249',
    'fullres': 'https://storage.googleapis.com/hific/clic2020/visualize.html?perPage=10&imgs=ad249bba099568403dc6b97bc37f8d74',
    'loadingRatio': '71.240234375%',
    'left': ['originals/kodim04.png', 'Original', 'Original'],
    'right': [
        ['outputs/mycodec/reconstructed/kodim04.png', 'JPEG quality=25', 'JPEG quality=25'],
        ['outputs/mycodec200/reconstructed/kodim04.jpg', 'JPEG quality=100', 'JPEG quality=100'],
        ['outputs/lossless/reconstructed/kodim04.png', 'PNG (lossless)', 'PNG (lossless)'],
        ['DIVIDER'],
        ['outputs/clustering/reconstructed/kodim04.png', 'Kmeans', 'Kmeans'],
        ['outputs/hific/reconstructed/kodim04.png', 'HiFiC', 'HiFiC'],
        ['outputs/stableDiff/reconstructed/kodim04.png_from_latents.png', 'Stable-diffusion', 'Stable-diffusion'],
        ['DIVIDER'],
        // ['kodim04_bpg_2x_0.313.png', 'BPG (0.313 bpp, \u22482x)', 'BPG (15 kB, \u22482x)'],
        ['originals/kodim04.png', 'Original', 'Original'],
    ],
    'thumb': 'thumbs/kodim04.jpg'
},
'tower': {
    'imginfo': 'CLIC2020/9cbf2',
    'fullres': 'https://storage.googleapis.com/hific/clic2020/visualize.html?perPage=10&imgs=9cbf2594f339c0d3d0f0ea25c62af52b',
    'loadingRatio': '66.650390625%',
    'left': ['originals/kodim14.png', 'Original', 'Original'],
    'right': [
        ['outputs/mycodec/reconstructed/kodim14.png', 'JPEG quality=25', 'JPEG quality=25'],
        ['outputs/mycodec200/reconstructed/kodim14.jpg', 'JPEG quality=100', 'JPEG quality=100'],
        ['outputs/lossless/reconstructed/kodim14.png', 'PNG (lossless)', 'PNG (lossless)'],
        ['DIVIDER'],
        ['outputs/clustering/reconstructed/kodim14.png', 'Kmeans', 'Kmeans'],
        ['outputs/hific/reconstructed/kodim14.png', 'HiFiC', 'HiFiC'],
        ['outputs/stableDiff/reconstructed/kodim14.png_from_latents.png', 'Stable-diffusion', 'Stable-diffusion'],
        ['DIVIDER'],
        // ['kodim14_bpg_2x_0.313.png', 'BPG (0.313 bpp, \u22482x)', 'BPG (15 kB, \u22482x)'],
        ['originals/kodim14.png', 'Original', 'Original'],
    ],
    'thumb': 'thumbs/kodim14.jpg'
},
'paris': {
    'imginfo': 'CLIC2020/1ac06',
    'fullres': 'https://storage.googleapis.com/hific/clic2020/visualize.html?perPage=10&imgs=1ac06ad4b53f9880698aaaaa730363c6',
    'loadingRatio': '75.0%',
    'left': ['originals/kodim17.png', 'Original', 'Original'],
    'right': [
        ['outputs/mycodec/reconstructed/kodim17.png', 'JPEG quality=25', 'JPEG quality=25'],
        ['outputs/mycodec200/reconstructed/kodim17.jpg', 'JPEG quality=100', 'JPEG quality=100'],
        ['outputs/lossless/reconstructed/kodim17.png', 'PNG (lossless)', 'PNG (lossless)'],
        ['DIVIDER'],
        ['outputs/clustering/reconstructed/kodim17.png', 'Kmeans', 'Kmeans'],
        ['outputs/hific/reconstructed/kodim17.png', 'HiFiC', 'HiFiC'],
        ['outputs/stableDiff/reconstructed/kodim17.png_from_latents.png', 'Stable-diffusion', 'Stable-diffusion'],
        ['DIVIDER'],
        // ['kodim17_bpg_2x_0.313.png', 'BPG (0.313 bpp, \u22482x)', 'BPG (15 kB, \u22482x)'],
        ['originals/kodim17.png', 'Original', 'Original'],
    ],
    'thumb': 'thumbs/kodim17.jpg'
},
'bus': {
    'imginfo': 'CLIC2020/4051a',
    'fullres': 'https://storage.googleapis.com/hific/clic2020/visualize.html?perPage=10&imgs=4051aeed928b0258553e2e6c7ce36466',
    'loadingRatio': '66.650390625%',
    'left': ['originals/kodim08.png', 'Original', 'Original'],
    'right': [
        ['outputs/mycodec/reconstructed/kodim08.png', 'JPEG quality=25', 'JPEG quality=25'],
        ['outputs/mycodec200/reconstructed/kodim08.jpg', 'JPEG quality=100', 'JPEG quality=100'],
        ['outputs/lossless/reconstructed/kodim08.png', 'PNG (lossless)', 'PNG (lossless)'],
        ['DIVIDER'],
        ['outputs/clustering/reconstructed/kodim08.png', 'Kmeans', 'Kmeans'],
        ['outputs/hific/reconstructed/kodim08.png', 'HiFiC', 'HiFiC'],
        ['outputs/stableDiff/reconstructed/kodim08.png_from_latents.png', 'Stable-diffusion', 'Stable-diffusion'],
        ['DIVIDER'],
        // ['kodim08_bpg_2x_0.313.png', 'BPG (0.313 bpp, \u22482x)', 'BPG (15 kB, \u22482x)'],
        ['originals/kodim08.png', 'Original', 'Original'],
    ],
    'thumb': 'thumbs/kodim08.jpg'
},
'plant': {
    'imginfo': 'CLIC2020/36720',
    'fullres': 'https://storage.googleapis.com/hific/clic2020/visualize.html?perPage=10&imgs=36720dbea875d6f7f81ade5b42eef871',
    'loadingRatio': '66.650390625%',
    'left': ['originals/kodim08.png', 'Original', 'Original'],
    'right': [
        ['outputs/mycodec/reconstructed/kodim08.png', 'JPEG quality=25', 'JPEG quality=25'],
        ['outputs/mycodec200/reconstructed/kodim08.jpg', 'JPEG quality=100', 'JPEG quality=100'],
        ['outputs/lossless/reconstructed/kodim08.png', 'PNG (lossless)', 'PNG (lossless)'],
        ['DIVIDER'],
        ['outputs/clustering/reconstructed/kodim08.png', 'Kmeans', 'Kmeans'],
        ['outputs/hific/reconstructed/kodim08.png', 'HiFiC', 'HiFiC'],   
        ['outputs/stableDiff/reconstructed/kodim08.png_from_latents.png', 'Stable-diffusion', 'Stable-diffusion'],
        ['DIVIDER'],
        // ['kodim08_bpg_2x_0.313.png', 'BPG (0.313 bpp, \u22482x)', 'BPG (15 kB, \u22482x)'],
        ['originals/kodim08.png', 'Original', 'Original'],
    ],
    'thumb': 'thumbs/kodim08.jpg'
},
'wall': {
    'imginfo': 'Kodak/kodim02.png',
    'fullres': 'https://storage.googleapis.com/hific/kodak/visualize.html?perPage=10&imgs=kodim02',
    'loadingRatio': '66.66666666666666%',
    'left': ['originals/kodim02.png', 'Original', 'Original'],
    'right': [
        ['outputs/mycodec/reconstructed/kodim02.png', 'JPEG quality=25', 'JPEG quality=25'],
        ['outputs/mycodec200/reconstructed/kodim02.jpg', 'JPEG quality=100', 'JPEG quality=100'],
        ['outputs/lossless/reconstructed/kodim02.png', 'PNG (lossless)', 'PNG (lossless)'],
        ['DIVIDER'],
        ['outputs/clustering/reconstructed/kodim02.png', 'Kmeans', 'Kmeans'],
        ['outputs/hific/reconstructed/kodim02.png', 'HiFiC', 'HiFiC'],
        ['outputs/stableDiff/reconstructed/kodim02.png_from_latents.png', 'Stable-diffusion', 'Stable-diffusion'],
        ['DIVIDER'],
        // ['kodim02_bpg_2x_0.313.png', 'BPG (0.313 bpp, \u22482x)', 'BPG (15 kB, \u22482x)'],
        ['originals/kodim02.png', 'Original', 'Original'],
    ],
    'thumb': 'thumbs/kodim02.jpg'
},
'kodim15': {
    'imginfo': 'Kodak/kodim15.png',
    'fullres': 'https://storage.googleapis.com/hific/kodak/visualize.html?perPage=10&imgs=kodim15',
    'loadingRatio': '66.66666666666666%',
    'left': ['originals/kodim15.png', 'Original', 'Original'],
    'right': [
        ['outputs/mycodec/reconstructed/kodim15.png', 'JPEG quality=25', 'JPEG quality=25'],
        ['outputs/mycodec200/reconstructed/kodim15.jpg', 'JPEG quality=100', 'JPEG quality=100'],
        ['outputs/lossless/reconstructed/kodim15.png', 'PNG (lossless)', 'PNG (lossless)'],
        ['DIVIDER'],
        ['outputs/clustering/reconstructed/kodim15.png', 'Kmeans', 'Kmeans'],
        ['outputs/hific/reconstructed/kodim15.png', 'HiFiC', 'HiFiC'],
        ['outputs/stableDiff/reconstructed/kodim15.png_from_latents.png', 'Stable-diffusion', 'Stable-diffusion'],
        ['DIVIDER'],
        // ['kodim15_bpg_2x_0.313.png', 'BPG (0.313 bpp, \u22482x)', 'BPG (15 kB, \u22482x)'],
        ['originals/kodim15.png', 'Original', 'Original'],
    ],
    'thumb': 'thumbs/kodim15.jpg'
},
};
/// INPUT_DATA_END

// let PREFIX = 'https://storage.googleapis.com/hific/data/img/';
let PREFIX = 'images/kodak/';

let order = ['shades', 'kodim15', 'wall', 'tower', 'food', 'bus', 'paris'];
let captionTypeToIndex = {'bpp': 1, 'bytes': 2};
let captionIndex = captionTypeToIndex['bytes'];
let currentImage = null;

$(document).ready(function () {
    $('input[type=radio][name=bpp-bytes-radio]').change(function() {
        captionIndex = captionTypeToIndex[this.value];
        showImgAndUpdateUI(currentImage, true);
    });
    $('#toggle-aff-fa-footnote').on('click', function (e) {
        $('#footnote-aff-fa').toggle();
        $('#footnote-aff-mi').hide();
    });
    $('#toggle-aff-mi-footnote').on('click', function (e) {
        $('#footnote-aff-mi').toggle();
        $('#footnote-aff-fa').hide();
    });
    $("#view-full-res").hover(
        function() {
            let title = $(this).attr("data-title");
            $('<div/>', {
                text: title,
                class: 'overlay-box'
            }).appendTo(this);
        }, function() {
            $(document).find("div.overlay-box").remove();
        }
    );
    // Add the img tags.
    $("#right-imgs").append($("<img>"));
    $("#left-img").append($("<img>", {"id": "left"}));
    // Setup slider and load first image.
    if ($(".comparison-slider")[0]) {
        let firstImageIndex = 1
        let compSlider = $(".comparison-slider");
        compSlider.each(function () {
            let compSliderWidth = $(this).width() + "px";
            $(this).find(".resize img").css({width: compSliderWidth});
            drags($(this).find(".divider"), $(this).find(".resize"), $(this));
        });
        $(window).on("resize", function () {
            let compSliderWidth = compSlider.width() + "px";
            compSlider.find(".resize img").css({width: compSliderWidth});
        });
        $('.image-selector').empty();
        order.forEach(function (v, index) {
            let thumbID = "img-sel-" + index.toString();
            let img =
                $('<img>', {
                    'id': "img-sel-" + index.toString(),
                    'class': "thumb" + (index === firstImageIndex ? " thumb-active" : "") + " " + thumbID,
                    'src': PREFIX + known[v]['thumb']});
            img.on('click', function (e) {
                let selectedThumb = e.target;
                let selectedThumbClasses = '.' + selectedThumb.className.split(' ').join('.');
                $('.thumb.thumb-active').removeClass('thumb-active');
                $(selectedThumbClasses).addClass('thumb-active');
                $(selectedThumb).addClass('thumb-active');
                let imgSelId = selectedThumb.id;
                let index = parseInt(imgSelId.replace("img-sel-", ""));
                console.log(index);
                let imgName = order[index];
                showImgAndUpdateUI(imgName, false);
            });
            $('.image-selector').append(img);
        });
        showImgAndUpdateUI(order[firstImageIndex], false);
    }
});

function showDividerInfo() {
    $('.divider-info').text('Drag Slider to Compare');
}

function showLeftImg(img, imgInfo, fullres, loadingRatio) {
    console.log('Showing left', img[0]);
    let imgName = img[0];
    let img_caption = img[captionIndex];
    $('#left-info-button').text(img_caption);
    $('#img-info-button').text(imgInfo);
    $('#view-full-res').attr('href', fullres);
    let leftImg = $('#left')[0];
    let showing = leftImg.src.split('/').reverse()[0];
    let loadingPlaceholder = $('#loading-placeholder');
    if (showing === imgName) {
        console.log('Left already on', imgName);
        loadingPlaceholder.css('display', 'none');
        showDividerInfo();
        return;
    }
    leftImg.src = PREFIX + imgName;
    if (leftImg.complete) {
        console.log('Loaded image immediately.');
        loadingPlaceholder.css('display', 'none');
        showDividerInfo();
        return;
    }
    let rightImgs = $('#right-imgs'); rightImgs.hide();
    $(leftImg).hide();
    loadingPlaceholder.css('display', 'block');
    loadingPlaceholder.css('padding-top', loadingRatio);
    function loaded() {
        console.log('Loaded image!');
        $(leftImg).show();
        rightImgs.show();
        loadingPlaceholder.css('display', 'none');
        loadingPlaceholder.css('padding-top', '0px');
        removeListeners();
        showDividerInfo();
    }
    function error() { console.log('Error when loading', newLeft); removeListeners(); }
    function removeListeners() {
        leftImg.removeEventListener('load', loaded);
        leftImg.removeEventListener('error', error);
    }
    removeListeners();
    leftImg.addEventListener('load', loaded);
    leftImg.addEventListener('error', error);
}

function showRights(imgName, imgs, force) {
    let rightsDiv = $('#right-imgs')[0];
    if (!force && rightsDiv.getAttribute("showing") === imgName) {
        console.log("Right already on", imgName);
        return;
    }
    let rightSelector = $(".right-selector")[0];
    $(rightSelector).empty();
    $(rightsDiv).empty();
    rightsDiv.setAttribute("showing", imgName);
    console.log(imgs, rightsDiv.getAttribute("showing"));
    let buttonGroupDiv = $("<div>", {'class': 'btn-group-vertical btn-group-sm', 'role': 'group'});
    $(rightSelector).append(buttonGroupDiv);
    imgs.forEach(function (item, index) {
        let cls = ["btn", "float-right", "right-sel-button"];
        if (index === 0) {
            cls.push('btn-dark');
            cls.push('active');
        } else {
            cls.push('btn-light');
        }
        cls.push('btn-block');
        let imgName = item[0];
        if (imgName === 'DIVIDER') {
            $(buttonGroupDiv).append($("<button>", {
                "type": "button",
                "class": cls.join(" ")
            }).prop("disabled", true).text(" "));
            return;
        }
        let caption = item[captionIndex];
        caption = caption.replace('x', '\u00D7');
        let imgTag = $("<img>", {'src': PREFIX + imgName, 'id': 'right-img-' + index.toString()});
        if (index !== 0) {
            $(imgTag).hide();
        }
        $(rightsDiv).append(imgTag);
        let caption_pre = caption.split('(')[0];
        let caption_post = caption.split('(')[1];
        let button = $("<button>", {
            "type": "button",
            "class": cls.join(" "),
            "id": 'right-btn-idx-' + index.toString()}).text(caption_pre);
        if (caption_post) {  // Not for original
            let span = $('<span>', {'class': 'codec-info'}).text('(' + caption_post);
            button.append(span);
        }
        button.on("click", function (e) {
            let oldActiveButton = $(".right-sel-button.active")[0];
            let oldIndex = oldActiveButton.id.replace('right-btn-idx-', '');
            let newActiveButton = e.target;
            if ($(newActiveButton).hasClass('codec-info')) {
                newActiveButton = $(newActiveButton).parent();
            }
            let newIndex = index.toString();
            if (oldIndex === newIndex) {
                console.log('Already selected!');
                return;
            }
            /// Switch images
            $('#right-img-' + newIndex).show();
            $('#right-img-' + oldIndex).hide();
            /// First disable old button
            $(oldActiveButton).removeClass('active');
            $(oldActiveButton).removeClass('btn-dark');
            $(oldActiveButton).addClass('btn-light');
            /// Set new button
            $(newActiveButton).addClass('active');
            $(newActiveButton).removeClass('btn-light');
            $(newActiveButton).addClass('btn-dark');
            console.log(e.target);

            let compSlider = $(".comparison-slider");
            let selectorWidth = parseFloat($(".right-selector").css("width"));
            let divider = $(compSlider).find(".divider");
            let parentWidth = parseFloat(divider.parent().css("width"));
            let dividerPos = parseFloat(divider.css("left"));
            let dividerOverlapsSelector = dividerPos > (parentWidth - selectorWidth);
            if (dividerOverlapsSelector) {
                let nonOverlapPos = parentWidth - selectorWidth - 30;
                console.log(divider.css("left"), selectorWidth);
                let resizer = $(compSlider).find(".resize");
                divider.css("left", nonOverlapPos);
                resizer.css("width", nonOverlapPos);
            }
        });
        $(buttonGroupDiv).append(button);
    });
}

function showImgAndUpdateUI(imgName, force) {
    currentImage = imgName;
    console.log('Showing', imgName);
    let imgs = known[imgName];
    let right = imgs['right'];
    showLeftImg(imgs['left'], imgs['imginfo'], imgs['fullres'], imgs['loadingRatio']);
    showRights(imgName, right, force);
}


function drags(dragElement, resizeElement, container) {
    let touched = false;
    window.addEventListener('touchstart', function () { touched = true; });
    window.addEventListener('touchend', function ()   { touched = false; });
    let dividerInfo = $('.divider-info');
    dragElement.on("mousedown touchstart", function (e) {
        dividerInfo.hide();
        dragElement.addClass("draggable");
        resizeElement.addClass("resizable");
        let startX = e.pageX ? e.pageX : e.originalEvent.touches[0].pageX;
        let dragWidth = dragElement.outerWidth();
        let posX = dragElement.offset().left + dragWidth - startX;
        let containerOffset = container.offset().left;
        let containerWidth = container.outerWidth();
        let minLeft = containerOffset + 10;
        let maxLeft = containerOffset + containerWidth - dragWidth - 10;
        dragElement.parents().on("mousemove touchmove", function (e) {
            if (touched === false) { e.preventDefault(); }  // Prevent selection.
            let moveX = e.pageX ? e.pageX : e.originalEvent.touches[0].pageX;
            let leftValue = moveX + posX - dragWidth;
            leftValue = Math.min(Math.max(leftValue, minLeft), maxLeft);  // Clip
            let widthValue = ((leftValue + dragWidth / 2 - containerOffset) / containerWidth * 100) + "%";
            $(".draggable").css("left", widthValue).on("mouseup touchend touchcancel", function () {
                $(this).removeClass("draggable");
                resizeElement.removeClass("resizable");
            });
            $(".resizable").css("width", widthValue);
        }).on("mouseup touchend touchcancel", function () {
            dragElement.removeClass("draggable");
            resizeElement.removeClass("resizable");
        });
    }).on("mouseup touchend touchcancel", function (e) {
        dragElement.removeClass("draggable");
        resizeElement.removeClass("resizable");
    });
}
